{% extends "base_new.html" %}

{% block title %}Emergency Drills - Emergency Management System{% endblock %}
{% block page_title %}Emergency Drills Management{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-1">Emergency Drills</h4>
                <p class="text-muted mb-0">Schedule, manage, and track emergency preparedness drills</p>
            </div>
            {% if session.get('user_role') in ['admin', 'spoc'] %}
            <div class="d-flex gap-2">
                <a href="{{ url_for('create_drill') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Create New Drill
                </a>
                <button class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#quickDrillModal">
                    <i class="fas fa-bolt me-2"></i>Quick Drill
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Drill Statistics -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="stats-card warning">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stats-number">{{ drills|length }}</div>
                    <div class="stats-label">Total Drills</div>
                </div>
                <div>
                    <i class="fas fa-users-cog" style="font-size: 2rem; opacity: 0.7;"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="stats-card success">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stats-number">{{ drills|selectattr('score', 'defined')|list|length }}</div>
                    <div class="stats-label">Completed</div>
                </div>
                <div>
                    <i class="fas fa-check-circle" style="font-size: 2rem; opacity: 0.7;"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="stats-card info">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stats-number">
                        {% set completed_drills = drills|selectattr('score', 'defined')|list %}
                        {% if completed_drills %}
                            {{ "%.1f"|format((completed_drills|sum(attribute='score'))/completed_drills|length) }}%
                        {% else %}
                            0%
                        {% endif %}
                    </div>
                    <div class="stats-label">Avg Score</div>
                </div>
                <div>
                    <i class="fas fa-star" style="font-size: 2rem; opacity: 0.7;"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="stats-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stats-number">{{ drills|selectattr('created_at')|selectattr('created_at', 'gt', (moment().subtract(30, 'days') if moment else ''))|list|length if moment else 0 }}</div>
                    <div class="stats-label">This Month</div>
                </div>
                <div>
                    <i class="fas fa-calendar" style="font-size: 2rem; opacity: 0.7;"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filter and Bulk Actions Bar -->
{% if drills %}
<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="selectAllDrills" onchange="toggleAllDrills()">
                    <label class="form-check-label" for="selectAllDrills">
                        Select All
                    </label>
                </div>
                <div class="bulk-actions" id="bulkActions" style="display: none;">
                    <button class="btn btn-sm btn-outline-warning" onclick="bulkStartDrills()">
                        <i class="fas fa-play me-1"></i>Start Selected
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="bulkExportDrills()">
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                    {% if session.get('user_role') == 'admin' %}
                    <button class="btn btn-sm btn-outline-danger" onclick="bulkDeleteDrills()">
                        <i class="fas fa-trash me-1"></i>Delete
                    </button>
                    {% endif %}
                </div>
            </div>
            <div class="drill-filters">
                <select class="form-select form-select-sm" id="drillTypeFilter" onchange="filterDrills()">
                    <option value="">All Types</option>
                    <option value="fire">Fire Evacuation</option>
                    <option value="earthquake">Earthquake</option>
                    <option value="flood">Flood Response</option>
                    <option value="lockdown">Security Lockdown</option>
                    <option value="medical">Medical Emergency</option>
                    <option value="bomb_threat">Bomb Threat</option>
                    <option value="chemical">Chemical Spill</option>
                    <option value="general">General Emergency</option>
                </select>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Drills Tabs Navigation -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-pills card-header-pills" id="drill-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="all-drills-tab" data-bs-toggle="pill" data-bs-target="#all-drills" type="button">
                            <i class="fas fa-list me-2"></i>All Drills
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="fire-drills-tab" data-bs-toggle="pill" data-bs-target="#fire-drills" type="button">
                            <i class="fas fa-fire me-2"></i>Fire Drills
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="earthquake-drills-tab" data-bs-toggle="pill" data-bs-target="#earthquake-drills" type="button">
                            <i class="fas fa-mountain me-2"></i>Earthquake
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="other-drills-tab" data-bs-toggle="pill" data-bs-target="#other-drills" type="button">
                            <i class="fas fa-ellipsis-h me-2"></i>Other
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="drill-content">
                    <!-- All Drills Tab -->
                    <div class="tab-pane fade show active" id="all-drills" role="tabpanel">
                        {% if drills %}
                        <div class="row">
                            <!-- Add New Drill Card -->
                            {% if session.get('user_role') in ['admin', 'spoc'] %}
                            <div class="col-lg-6 col-xl-4 mb-4">
                                <div class="card h-100 border-2 border-dashed" style="border-color: #dee2e6 !important;">
                                    <div class="card-body d-flex flex-column justify-content-center align-items-center text-center">
                                        <i class="fas fa-plus fa-3x text-muted mb-3"></i>
                                        <h6 class="text-muted mb-3">Add New Drill</h6>
                                        <div class="d-grid gap-2 w-100">
                                            <a href="{{ url_for('create_drill') }}" class="btn btn-outline-primary">
                                                <i class="fas fa-plus me-2"></i>Full Form
                                            </a>
                                            <button class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#quickDrillModal">
                                                <i class="fas fa-bolt me-2"></i>Quick Add
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            
                            {% for drill in drills %}
                            <div class="col-lg-6 col-xl-4 mb-4">
                                <div class="card h-100 drill-card" data-drill-type="{{ drill.drill_type }}">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <div class="d-flex align-items-center gap-2">
                                                <input class="form-check-input drill-checkbox" type="checkbox" value="{{ drill.id }}" onchange="updateBulkActions()">
                                                <div class="drill-type-badge">
                                                    <span class="badge bg-{% if drill.drill_type == 'fire' %}danger{% elif drill.drill_type == 'earthquake' %}warning{% elif drill.drill_type == 'flood' %}info{% else %}secondary{% endif %}">
                                                        <i class="fas fa-{% if drill.drill_type == 'fire' %}fire{% elif drill.drill_type == 'earthquake' %}mountain{% elif drill.drill_type == 'flood' %}water{% else %}users-cog{% endif %} me-1"></i>
                                                        {{ drill.drill_type.title() }}
                                                    </span>
                                                </div>
                                            </div>
                                            <div class="dropdown">
                                                <button class="btn btn-link btn-sm p-0" data-bs-toggle="dropdown">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </button>
                                                <ul class="dropdown-menu dropdown-menu-end">
                                                    <li><a class="dropdown-item" href="#" onclick="viewDrill({{ drill.id }})"><i class="fas fa-eye me-2"></i>View Details</a></li>
                                                    {% if session.get('user_role') == 'admin' %}
                                                    <li><a class="dropdown-item" href="#" onclick="editDrill({{ drill.id }})"><i class="fas fa-edit me-2"></i>Edit</a></li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteDrill({{ drill.id }})"><i class="fas fa-trash me-2"></i>Delete</a></li>
                                                    {% endif %}
                                                </ul>
                                            </div>
                                        </div>
                                        
                                        <h6 class="card-title">{{ drill.title }}</h6>
                                        <p class="card-text text-muted small">{{ drill.description[:100] }}{% if drill.description|length > 100 %}...{% endif %}</p>
                                        
                                        <div class="drill-stats">
                                            <div class="row text-center">
                                                <div class="col-4">
                                                    <div class="stat-item">
                                                        <div class="stat-number">{{ drill.total_expected }}</div>
                                                        <div class="stat-label">Expected</div>
                                                    </div>
                                                </div>
                                                <div class="col-4">
                                                    <div class="stat-item">
                                                        <div class="stat-number">{{ drill.participants_count or 0 }}</div>
                                                        <div class="stat-label">Attended</div>
                                                    </div>
                                                </div>
                                                <div class="col-4">
                                                    <div class="stat-item">
                                                        <div class="stat-number">{{ drill.score or 'N/A' }}{% if drill.score %}%{% endif %}</div>
                                                        <div class="stat-label">Score</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        {% if drill.score %}
                                        <div class="progress mb-3" style="height: 6px;">
                                            <div class="progress-bar bg-{% if drill.score >= 80 %}success{% elif drill.score >= 60 %}warning{% else %}danger{% endif %}" 
                                                 style="width: {{ drill.score }}%"></div>
                                        </div>
                                        {% endif %}
                                        
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">
                                                <i class="fas fa-calendar me-1"></i>
                                                {{ drill.created_at.strftime('%Y-%m-%d') }}
                                            </small>
                                            {% if drill.file_url %}
                                            <a href="{{ url_for('static', filename=drill.file_url) }}" class="btn btn-outline-primary btn-sm" target="_blank">
                                                <i class="fas fa-download me-1"></i>Materials
                                            </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                    
                                    <div class="card-footer bg-transparent">
                                        <div class="d-grid gap-2 d-md-flex">
                                            <button class="btn btn-outline-success btn-sm flex-fill" onclick="markAttendance({{ drill.id }})">
                                                <i class="fas fa-user-check me-1"></i>Mark Attendance
                                            </button>
                                            <button class="btn btn-outline-info btn-sm flex-fill" onclick="viewResults({{ drill.id }})">
                                                <i class="fas fa-chart-bar me-1"></i>Results
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-users-cog fa-4x text-muted mb-4"></i>
                            <h4 class="text-muted mb-3">No Emergency Drills Found</h4>
                            <p class="text-muted mb-4">Get started by creating your first emergency drill to improve preparedness.</p>
                            {% if session.get('user_role') in ['admin', 'spoc'] %}
                            <div class="d-flex gap-2 justify-content-center">
                                <a href="{{ url_for('create_drill') }}" class="btn btn-primary btn-lg">
                                    <i class="fas fa-plus me-2"></i>Create First Drill
                                </a>
                                <button class="btn btn-outline-info btn-lg" data-bs-toggle="modal" data-bs-target="#quickDrillModal">
                                    <i class="fas fa-bolt me-2"></i>Quick Start
                                </button>
                            </div>
                            <div class="mt-4">
                                <small class="text-muted">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    Tip: Regular emergency drills help ensure everyone knows what to do in a real emergency
                                </small>
                            </div>
                            {% else %}
                            <p class="text-muted">Contact your administrator to schedule emergency drills.</p>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Fire Drills Tab -->
                    <div class="tab-pane fade" id="fire-drills" role="tabpanel">
                        <div class="row">
                            {% for drill in drills if drill.drill_type == 'fire' %}
                            <!-- Same drill card structure as above -->
                            <div class="col-lg-6 col-xl-4 mb-4">
                                <div class="card h-100 drill-card">
                                    <div class="card-body">
                                        <h6 class="card-title">{{ drill.title }}</h6>
                                        <p class="card-text text-muted">{{ drill.description[:100] }}...</p>
                                    </div>
                                </div>
                            </div>
                            {% else %}
                            <div class="col-12">
                                <div class="text-center py-5">
                                    <i class="fas fa-fire fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">No fire drills scheduled</h5>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Similar structure for other tabs -->
                    <div class="tab-pane fade" id="earthquake-drills" role="tabpanel">
                        <div class="text-center py-5">
                            <i class="fas fa-mountain fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Earthquake drills will be displayed here</h5>
                        </div>
                    </div>
                    
                    <div class="tab-pane fade" id="other-drills" role="tabpanel">
                        <div class="text-center py-5">
                            <i class="fas fa-ellipsis-h fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Other drills will be displayed here</h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.drill-card {
    transition: all 0.3s ease;
    border: 1px solid #e3e6f0;
}

.drill-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}

.stat-item {
    padding: 0.5rem 0;
}

.stat-number {
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--primary-color);
}

.stat-label {
    font-size: 0.75rem;
    color: #6c757d;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.drill-type-badge .badge {
    font-size: 0.75rem;
    padding: 0.5rem 0.75rem;
}

/* Floating Action Button */
.floating-action-btn {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    transition: all 0.3s ease;
    z-index: 1000;
}

.floating-action-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 25px rgba(0,0,0,0.4);
    color: white;
}

.floating-action-btn:active {
    transform: scale(0.95);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Bulk Operations and Filtering
function toggleAllDrills() {
    const selectAll = document.getElementById('selectAllDrills');
    const checkboxes = document.querySelectorAll('.drill-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
    
    updateBulkActions();
}

function updateBulkActions() {
    const checkedBoxes = document.querySelectorAll('.drill-checkbox:checked');
    const bulkActions = document.getElementById('bulkActions');
    
    if (checkedBoxes.length > 0) {
        bulkActions.style.display = 'block';
    } else {
        bulkActions.style.display = 'none';
    }
    
    // Update select all checkbox state
    const allCheckboxes = document.querySelectorAll('.drill-checkbox');
    const selectAll = document.getElementById('selectAllDrills');
    
    if (checkedBoxes.length === allCheckboxes.length) {
        selectAll.checked = true;
        selectAll.indeterminate = false;
    } else if (checkedBoxes.length > 0) {
        selectAll.checked = false;
        selectAll.indeterminate = true;
    } else {
        selectAll.checked = false;
        selectAll.indeterminate = false;
    }
}

function filterDrills() {
    const filter = document.getElementById('drillTypeFilter').value;
    const drillCards = document.querySelectorAll('.drill-card');
    
    drillCards.forEach(card => {
        const drillType = card.dataset.drillType;
        if (!filter || drillType === filter) {
            card.closest('.col-lg-6').style.display = 'block';
        } else {
            card.closest('.col-lg-6').style.display = 'none';
        }
    });
}

function bulkStartDrills() {
    const selectedDrills = Array.from(document.querySelectorAll('.drill-checkbox:checked')).map(cb => cb.value);
    if (selectedDrills.length === 0) return;
    
    if (confirm(`Start ${selectedDrills.length} selected drill(s)?`)) {
        // Implement bulk start functionality
        alert(`Starting ${selectedDrills.length} drills: ${selectedDrills.join(', ')}`);
    }
}

function bulkExportDrills() {
    const selectedDrills = Array.from(document.querySelectorAll('.drill-checkbox:checked')).map(cb => cb.value);
    if (selectedDrills.length === 0) return;
    
    // Create simple CSV export of selected drills
    let csv = 'Drill ID,Title,Type,Expected Participants\n';
    selectedDrills.forEach(drillId => {
        // This would normally fetch drill data from the server
        csv += `${drillId},Drill ${drillId},Sample Type,100\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `selected_drills_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}

function bulkDeleteDrills() {
    const selectedDrills = Array.from(document.querySelectorAll('.drill-checkbox:checked')).map(cb => cb.value);
    if (selectedDrills.length === 0) return;
    
    if (confirm(`Are you sure you want to delete ${selectedDrills.length} selected drill(s)? This action cannot be undone.`)) {
        // Implement bulk delete functionality
        alert(`Deleting ${selectedDrills.length} drills: ${selectedDrills.join(', ')}`);
    }
}

// Existing Functions
function viewDrill(drillId) {
    // Implement drill detail view
    alert('View drill details: ' + drillId);
}

function editDrill(drillId) {
    // Implement drill editing
    alert('Edit drill: ' + drillId);
}

function deleteDrill(drillId) {
    if (confirm('Are you sure you want to delete this drill? This action cannot be undone.')) {
        // Implement drill deletion
        alert('Delete drill: ' + drillId);
    }
}

function markAttendance(drillId) {
    // Implement attendance marking
    const modal = new bootstrap.Modal(document.getElementById('attendanceModal') || createAttendanceModal());
    modal.show();
}

function viewResults(drillId) {
    // Implement results viewing
    alert('View drill results: ' + drillId);
}

function createAttendanceModal() {
    const modalHtml = `
        <div class="modal fade" id="attendanceModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Mark Drill Attendance</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p>Mark your attendance for this drill:</p>
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-success" onclick="submitAttendance('present')">
                                <i class="fas fa-check me-2"></i>Present
                            </button>
                            <button type="button" class="btn btn-warning" onclick="submitAttendance('late')">
                                <i class="fas fa-clock me-2"></i>Late
                            </button>
                            <button type="button" class="btn btn-danger" onclick="submitAttendance('absent')">
                                <i class="fas fa-times me-2"></i>Absent
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    return document.getElementById('attendanceModal');
}

function submitAttendance(status) {
    // Implement attendance submission
    bootstrap.Modal.getInstance(document.getElementById('attendanceModal')).hide();
    alert('Attendance marked as: ' + status);
}
</script>

<!-- Floating Action Button for Mobile -->
{% if session.get('user_role') in ['admin', 'spoc'] %}
<div class="floating-action-btn d-lg-none" data-bs-toggle="modal" data-bs-target="#quickDrillModal">
    <i class="fas fa-plus"></i>
</div>
{% endif %}

<!-- Quick Drill Creation Modal -->
<div class="modal fade" id="quickDrillModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-bolt me-2"></i>Quick Drill Creation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('create_drill') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="quickTitle" class="form-label">Drill Title <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="quickTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="quickType" class="form-label">Drill Type <span class="text-danger">*</span></label>
                        <select class="form-control" id="quickType" name="drill_type" required>
                            <option value="">Select drill type</option>
                            <option value="fire">Fire Evacuation</option>
                            <option value="earthquake">Earthquake</option>
                            <option value="flood">Flood Response</option>
                            <option value="lockdown">Security Lockdown</option>
                            <option value="medical">Medical Emergency</option>
                            <option value="bomb_threat">Bomb Threat</option>
                            <option value="chemical">Chemical Spill</option>
                            <option value="general">General Emergency</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="quickDescription" class="form-label">Description <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="quickDescription" name="description" rows="3" required placeholder="Brief description of the drill..."></textarea>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <div class="mb-3">
                                <label for="quickExpected" class="form-label">Expected Participants</label>
                                <input type="number" class="form-control" id="quickExpected" name="total_expected" value="100" min="1">
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-3">
                                <label class="form-label">Status</label>
                                <select class="form-control" name="status">
                                    <option value="scheduled">Scheduled</option>
                                    <option value="active">Start Immediately</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Quick Drill:</strong> This will create a basic drill. For more advanced options, use the full drill creation form.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Create Drill
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}
