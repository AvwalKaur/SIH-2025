{% extends "base_new.html" %}

{% block title %}Safety Check-ins - Emergency Management System{% endblock %}
{% block page_title %}Safety Check-ins & Attendance{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-1">Safety Check-ins</h4>
                <p class="text-muted mb-0">Monitor real-time safety status and attendance tracking</p>
            </div>
            <button class="btn btn-success" onclick="quickCheckin()">
                <i class="fas fa-user-check me-2"></i>Quick Check-in
            </button>
        </div>
    </div>
</div>

<!-- Safety Status Overview -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="stats-card success">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stats-number">{{ stats.safe }}</div>
                    <div class="stats-label">Safe Check-ins</div>
                </div>
                <div>
                    <i class="fas fa-shield-alt" style="font-size: 2rem; opacity: 0.7;"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="stats-card danger">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stats-number">{{ stats.stuck }}</div>
                    <div class="stats-label">Need Help</div>
                </div>
                <div>
                    <i class="fas fa-exclamation-triangle" style="font-size: 2rem; opacity: 0.7;"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="stats-card warning">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stats-number">{{ stats.unknown }}</div>
                    <div class="stats-label">Unknown Status</div>
                </div>
                <div>
                    <i class="fas fa-question-circle" style="font-size: 2rem; opacity: 0.7;"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-3">
        <div class="stats-card info">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stats-number">{{ stats.total }}</div>
                    <div class="stats-label">Total Check-ins</div>
                </div>
                <div>
                    <i class="fas fa-users" style="font-size: 2rem; opacity: 0.7;"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Live Status Board -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-broadcast-tower me-2 text-success"></i>
                        Live Safety Status Board
                        <span class="badge bg-success ms-2">LIVE</span>
                    </h6>
                    <div>
                        <span class="text-muted me-3">
                            Last updated: <span id="lastUpdated">Just now</span>
                        </span>
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshStatus()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Safe Zone -->
                    <div class="col-md-4">
                        <div class="safety-zone safe-zone">
                            <div class="zone-header">
                                <i class="fas fa-shield-alt"></i>
                                <h6>Safe Zone</h6>
                                <span class="zone-count">{{ stats.safe }}</span>
                            </div>
                            <div class="zone-content">
                                {% for checkin in checkins if checkin.status == 'safe' %}
                                <div class="status-item">
                                    <div class="status-avatar">
                                        {{ checkin.user.name[0].upper() if checkin.user else 'U' }}
                                    </div>
                                    <div class="status-info">
                                        <div class="status-name">{{ checkin.user.name if checkin.user else 'Unknown User' }}</div>
                                        <div class="status-location">
                                            <i class="fas fa-map-marker-alt me-1"></i>
                                            {{ checkin.location or 'Location not specified' }}
                                        </div>
                                        <div class="status-time">{{ checkin.created_at.strftime('%H:%M') }}</div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Need Help Zone -->
                    <div class="col-md-4">
                        <div class="safety-zone help-zone">
                            <div class="zone-header">
                                <i class="fas fa-exclamation-triangle"></i>
                                <h6>Need Help</h6>
                                <span class="zone-count">{{ stats.stuck }}</span>
                            </div>
                            <div class="zone-content">
                                {% for checkin in checkins if checkin.status == 'stuck' %}
                                <div class="status-item urgent">
                                    <div class="status-avatar">
                                        {{ checkin.user.name[0].upper() if checkin.user else 'U' }}
                                    </div>
                                    <div class="status-info">
                                        <div class="status-name">{{ checkin.user.name if checkin.user else 'Unknown User' }}</div>
                                        <div class="status-location">
                                            <i class="fas fa-map-marker-alt me-1"></i>
                                            {{ checkin.location or 'Location not specified' }}
                                        </div>
                                        <div class="status-time">{{ checkin.created_at.strftime('%H:%M') }}</div>
                                        {% if checkin.message %}
                                        <div class="status-message">{{ checkin.message }}</div>
                                        {% endif %}
                                    </div>
                                    <div class="status-actions">
                                        <button class="btn btn-sm btn-outline-danger">
                                            <i class="fas fa-life-ring"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- Unknown Status Zone -->
                    <div class="col-md-4">
                        <div class="safety-zone unknown-zone">
                            <div class="zone-header">
                                <i class="fas fa-question-circle"></i>
                                <h6>Unknown Status</h6>
                                <span class="zone-count">{{ stats.unknown }}</span>
                            </div>
                            <div class="zone-content">
                                {% for checkin in checkins if checkin.status == 'unknown' %}
                                <div class="status-item">
                                    <div class="status-avatar">
                                        {{ checkin.user.name[0].upper() if checkin.user else 'U' }}
                                    </div>
                                    <div class="status-info">
                                        <div class="status-name">{{ checkin.user.name if checkin.user else 'Unknown User' }}</div>
                                        <div class="status-location">
                                            <i class="fas fa-map-marker-alt me-1"></i>
                                            {{ checkin.location or 'Location not specified' }}
                                        </div>
                                        <div class="status-time">{{ checkin.created_at.strftime('%H:%M') }}</div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Check-ins Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-history me-2"></i>
                    Recent Check-ins History
                </h6>
            </div>
            <div class="card-body">
                {% if checkins %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>User</th>
                                <th>Status</th>
                                <th>Location</th>
                                <th>Message</th>
                                <th>Time</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for checkin in checkins[:20] %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="status-avatar me-2">
                                            {{ checkin.user.name[0].upper() if checkin.user else 'U' }}
                                        </div>
                                        <div>
                                            <div class="fw-medium">{{ checkin.user.name if checkin.user else 'Unknown User' }}</div>
                                            <small class="text-muted">{{ checkin.user.email if checkin.user else 'No email' }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-{% if checkin.status == 'safe' %}success{% elif checkin.status == 'stuck' %}danger{% else %}warning{% endif %}">
                                        <i class="fas fa-{% if checkin.status == 'safe' %}shield-alt{% elif checkin.status == 'stuck' %}exclamation-triangle{% else %}question-circle{% endif %} me-1"></i>
                                        {{ checkin.status.title() }}
                                    </span>
                                </td>
                                <td>
                                    <i class="fas fa-map-marker-alt text-muted me-1"></i>
                                    {{ checkin.location or 'Not specified' }}
                                </td>
                                <td>
                                    {% if checkin.message %}
                                        <span class="text-truncate" style="max-width: 200px;" title="{{ checkin.message }}">
                                            {{ checkin.message }}
                                        </span>
                                    {% else %}
                                        <span class="text-muted">No message</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small class="text-muted">
                                        {{ checkin.created_at.strftime('%Y-%m-%d %H:%M') }}
                                    </small>
                                </td>
                                <td>
                                    {% if checkin.status == 'stuck' %}
                                    <button class="btn btn-outline-danger btn-sm" onclick="respondToHelp({{ checkin.id }})">
                                        <i class="fas fa-life-ring me-1"></i>Respond
                                    </button>
                                    {% else %}
                                    <button class="btn btn-outline-info btn-sm" onclick="contactUser({{ checkin.user.id if checkin.user else 0 }})">
                                        <i class="fas fa-phone me-1"></i>Contact
                                    </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-user-check fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No check-ins yet</h5>
                    <p class="text-muted">No safety check-ins have been recorded.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Quick Check-in Modal -->
<div class="modal fade" id="checkinModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Safety Check-in</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="checkinForm">
                    <div class="mb-3">
                        <label class="form-label">Current Safety Status</label>
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-outline-success btn-lg" onclick="submitCheckin('safe')">
                                <i class="fas fa-shield-alt me-2"></i>I'm Safe
                            </button>
                            <button type="button" class="btn btn-outline-warning btn-lg" onclick="submitCheckin('unknown')">
                                <i class="fas fa-question-circle me-2"></i>Status Unknown
                            </button>
                            <button type="button" class="btn btn-outline-danger btn-lg" onclick="submitCheckin('stuck')">
                                <i class="fas fa-exclamation-triangle me-2"></i>Need Help
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="location" class="form-label">Current Location</label>
                        <input type="text" class="form-control" id="location" placeholder="Enter your current location">
                    </div>
                    <div class="mb-3">
                        <label for="message" class="form-label">Additional Message (Optional)</label>
                        <textarea class="form-control" id="message" rows="3" placeholder="Any additional information..."></textarea>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.safety-zone {
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
    min-height: 300px;
}

.safe-zone {
    background: linear-gradient(135deg, #d4edda, #c3e6cb);
    border: 2px solid #28a745;
}

.help-zone {
    background: linear-gradient(135deg, #f8d7da, #f1b2b7);
    border: 2px solid #dc3545;
}

.unknown-zone {
    background: linear-gradient(135deg, #fff3cd, #ffeaa7);
    border: 2px solid #ffc107;
}

.zone-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid rgba(0,0,0,0.1);
}

.zone-header i {
    font-size: 1.5rem;
}

.zone-header h6 {
    margin: 0;
    font-weight: 600;
}

.zone-count {
    font-size: 1.5rem;
    font-weight: 700;
    background: rgba(255,255,255,0.8);
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
}

.status-item {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    background: rgba(255,255,255,0.7);
    border-radius: 8px;
    transition: all 0.3s ease;
}

.status-item:hover {
    background: rgba(255,255,255,0.9);
    transform: translateX(5px);
}

.status-item.urgent {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
    100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
}

.status-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    margin-right: 0.75rem;
    flex-shrink: 0;
}

.status-info {
    flex-grow: 1;
}

.status-name {
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.status-location, .status-time {
    font-size: 0.8rem;
    color: #6c757d;
}

.status-message {
    font-size: 0.8rem;
    color: #495057;
    font-style: italic;
    margin-top: 0.25rem;
}

.status-actions {
    margin-left: 0.5rem;
}

#lastUpdated {
    font-weight: 600;
    color: var(--success-color);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function quickCheckin() {
    const modal = new bootstrap.Modal(document.getElementById('checkinModal'));
    modal.show();
}

function submitCheckin(status) {
    const location = document.getElementById('location').value;
    const message = document.getElementById('message').value;
    
    fetch('/checkin', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `status=${status}&location=${encodeURIComponent(location)}&message=${encodeURIComponent(message)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('checkinModal')).hide();
            location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error submitting check-in');
    });
}

function refreshStatus() {
    location.reload();
}

function respondToHelp(checkinId) {
    if (confirm('Initiate emergency response for this person?')) {
        alert('Emergency response initiated for check-in ID: ' + checkinId);
    }
}

function contactUser(userId) {
    alert('Contact user ID: ' + userId);
}

// Auto-refresh every 30 seconds
setInterval(function() {
    document.getElementById('lastUpdated').textContent = 'Just now';
}, 30000);

// Update time display
function updateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('en-US', {
        hour12: false,
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    });
    document.getElementById('lastUpdated').textContent = timeString;
}

// Update time every second
setInterval(updateTime, 1000);
</script>
{% endblock %}
