<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disaster Management Support Chatbot</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #1a73e8;
            --primary-light: #4285f4;
            --secondary: #34a853;
            --accent: #f25c54;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-sidebar: #f5f6fa;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --border: #e8eaed;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.15);
            --radius: 8px;
            --transition: all 0.2s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
        }
        
        /* Sidebar - Conversation History */
        .sidebar {
            width: 300px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-primary);
        }
        
        .app-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }
        
        .app-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }
        
        .sidebar-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .sidebar-btn {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border);
            background: var(--bg-primary);
            color: var(--text-primary);
            border-radius: var(--radius);
            font-size: 13px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .sidebar-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--primary);
        }
        
        .search-container {
            position: relative;
            margin-bottom: 12px;
        }
        
        .search-input {
            width: 100%;
            padding: 10px 40px 10px 14px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 14px;
            background: var(--bg-primary);
            color: var(--text-primary);
            outline: none;
            transition: var(--transition);
        }
        
        .search-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
        }
        
        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 14px;
        }
        
        .user-profile {
            padding: 12px;
            background: var(--bg-primary);
            border-radius: var(--radius);
            margin: 16px;
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid var(--border);
            border-top: 1px solid var(--border);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .user-profile:hover {
            background: var(--bg-secondary);
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-light));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }
        
        .user-info {
            flex: 1;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        
        .user-status {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        
        .history-item {
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--border);
            position: relative;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            box-shadow: var(--shadow);
        }
        
        .history-item:hover {
            background: var(--bg-secondary);
            border-color: var(--primary);
            box-shadow: var(--shadow-hover);
        }
        
        .history-item:hover .delete-chat-btn {
            opacity: 1;
            visibility: visible;
        }
        
        .history-item:hover .edit-chat-btn {
            opacity: 1;
            visibility: visible;
        }
        
        .history-item.active {
            background: var(--bg-primary);
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
        }
        
        .history-content {
            flex: 1;
            pointer-events: none;
            padding-right: 60px; /* Make space for both buttons */
        }
        
        .delete-chat-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 24px;
            height: 24px;
            border: none;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            pointer-events: auto;
            z-index: 10;
        }
        
        .delete-chat-btn:hover {
            background: #d32f2f;
            transform: scale(1.1);
        }
        
        .edit-chat-btn {
            position: absolute;
            top: 12px;
            right: 42px;
            width: 24px;
            height: 24px;
            border: none;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            pointer-events: auto;
            z-index: 10;
        }
        
        .edit-chat-btn:hover {
            background: var(--primary-light);
            transform: scale(1.1);
        }
        
        .history-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 4px;
            color: var(--text-primary);
        }
        
        .history-preview {
            font-size: 12px;
            color: var(--text-secondary);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .history-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        /* Main Chat Area */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
        }
        
        .chat-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-primary);
        }
        
        .chat-title {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .chat-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }
        
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            background: var(--bg-secondary);
        }
        
        .message {
            margin-bottom: 24px;
            display: flex;
            gap: 12px;
            animation: slideIn 0.3s ease;
        }
        
        .user-message {
            flex-direction: row;
        }
        
        .ai-message {
            flex-direction: row-reverse;
            justify-content: flex-start;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }
        
        .user-avatar {
            background: var(--primary);
            color: white;
        }
        
        .ai-avatar {
            background: var(--secondary);
            color: white;
        }
        
        .message-content {
            flex: 1;
            max-width: calc(100% - 80px);
        }
        
        .message-text {
            background: var(--bg-primary);
            padding: 12px 16px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .user-message .message-text {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .ai-message .message-text {
            background: var(--bg-secondary);
            border-color: var(--border);
        }
        
        .ai-message .message-time {
            text-align: right;
        }
        
        .message-time {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 6px;
        }
        
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            flex-direction: row-reverse;
            justify-content: flex-start;
        }
        
        .typing-dots {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: var(--bg-primary);
            border-radius: var(--radius);
            border: 1px solid var(--border);
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            background: var(--text-secondary);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: 0ms; }
        .typing-dot:nth-child(2) { animation-delay: 200ms; }
        .typing-dot:nth-child(3) { animation-delay: 400ms; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-8px); opacity: 1; }
        }
        
        /* Input Area */
        .input-area {
            padding: 20px 24px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border);
        }
        
        .input-container {
            display: flex;
            align-items: flex-end;
            gap: 12px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .input-wrapper {
            flex: 1;
            display: flex;
            align-items: flex-end;
            gap: 8px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 22px;
            padding: 4px;
            transition: var(--transition);
        }
        
        .input-wrapper:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.1);
        }
        
        .mic-btn-left {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            background: transparent;
            color: var(--text-secondary);
            transition: var(--transition);
            margin-left: 4px;
        }
        
        .mic-btn-left:hover {
            background: var(--bg-secondary);
            color: var(--primary);
        }
        
        .mic-btn-left.recording {
            background: var(--accent);
            color: white;
            animation: pulse 1.5s infinite;
        }
        
        .message-input {
            flex: 1;
            min-height: 44px;
            max-height: 120px;
            padding: 12px 16px;
            border: none;
            outline: none;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            background: transparent;
        }
        
        .input-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-btn {
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: var(--transition);
        }
        
        .attach-btn {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        
        .attach-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .mic-btn {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }
        
        .mic-btn:hover {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }
        
        .mic-btn.recording {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .send-btn {
            background: var(--primary);
            color: white;
        }
        
        .send-btn:hover {
            background: var(--primary-light);
        }
        
        .send-btn:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
        }
        
        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 40px;
        }
        
        .empty-icon {
            width: 80px;
            height: 80px;
            background: var(--bg-sidebar);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }
        
        .empty-title {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-primary);
        }
        
        .empty-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }
        
        .suggestion-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            max-width: 400px;
        }
        
        .chip {
            padding: 8px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 16px;
            font-size: 13px;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .chip:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* File upload styles */
        .file-message {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            margin-top: 8px;
            max-width: 300px;
        }
        
        .user-message .file-message {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .file-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            flex-shrink: 0;
        }
        
        .file-info {
            flex: 1;
            min-width: 0;
        }
        
        .file-name {
            font-weight: 500;
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .user-message .file-name {
            color: white;
        }
        
        .file-size {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .user-message .file-size {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .file-preview {
            width: 200px;
            max-height: 200px;
            border-radius: 8px;
            object-fit: cover;
            margin-top: 8px;
        }
        
        .upload-progress {
            position: relative;
            overflow: hidden;
        }
        
        .upload-progress::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: uploadShimmer 1.5s infinite;
        }
        
        @keyframes uploadShimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .processing-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border-radius: 16px;
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 8px;
        }
        
        .processing-spinner {
            width: 12px;
            height: 12px;
            border: 2px solid var(--border);
            border-top: 2px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 280px;
            }
            
            .messages-container {
                padding: 16px;
            }
            
            .input-area {
                padding: 16px;
            }
        }
        
        @media (max-width: 640px) {
            .sidebar {
                position: fixed;
                left: -300px;
                z-index: 1000;
                transition: var(--transition);
            }
            
            .sidebar.open {
                left: 0;
            }
            
            .main-area {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar - Chat History -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="app-title">DisasterAI Assistant</div>
                <div class="app-subtitle">AI-powered disaster guidance and support</div>
                
                <div class="sidebar-actions">
                    <button class="sidebar-btn" onclick="startNewChat()">
                        <i class="fas fa-plus"></i>
                        New Chat
                    </button>
                    <button class="sidebar-btn" onclick="toggleSearch()">
                        <i class="fas fa-search"></i>
                        Search
                    </button>
                </div>
                
                <div class="search-container" id="searchContainer" style="display: none;">
                    <input type="text" class="search-input" id="searchInput" placeholder="Search chats..." onkeyup="searchChats()" />
                    <i class="fas fa-search search-icon"></i>
                </div>
            </div>
            
            <div class="chat-history" id="chatHistory">
                <!-- Chat history will be populated here -->
            </div>
            
            <div class="user-profile">
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-info">
                    <div class="user-name" id="userName">User</div>
                    <div class="user-status">Online</div>
                </div>
            </div>
        </div>
        
        <!-- Main Chat Area -->
        <div class="main-area">
            <div class="chat-header">
                <div class="chat-title" id="chatTitle">New Chat</div>
                <div class="chat-subtitle">AI-powered emergency guidance and support</div>
            </div>
            
            <div class="messages-container" id="messagesContainer">
                <div class="empty-state" id="emptyState">
                    <div class="empty-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="empty-title">How can I help you today?</div>
                    <div class="empty-subtitle">Ask me about disaster preparedness, emergency situations, or if you need psychological support. Upload images, videos, or PDFs for specialized analysis with enhanced AI prompts.</div>
                    
                    <div class="suggestion-chips">
                        <div class="chip" onclick="sendSuggestion('I am feeling anxious about disaster')">😰 Feeling Anxious</div>
                        <div class="chip" onclick="sendSuggestion('Emergency preparedness tips')">🎒 Preparedness</div>
                        <div class="chip" onclick="sendSuggestion('First aid guidance')">🏥 First Aid</div>
                    </div>
                </div>
            </div>
            
            <div class="input-area">
                <div class="input-container">
                    <div class="input-wrapper">
                        <button class="mic-btn-left" id="micBtn" title="Voice input">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <textarea 
                            class="message-input" 
                            id="messageInput" 
                            placeholder="Type your message here..."
                            rows="1"
                        ></textarea>
                    </div>
                    <div class="input-actions">
                        <label for="fileInput" class="action-btn attach-btn" title="Attach file">
                            <i class="fas fa-paperclip"></i>
                        </label>
                        <input type="file" id="fileInput" accept="image/*,video/*,.pdf" style="display: none;">
                        <button class="action-btn send-btn" id="sendBtn" title="Send message">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentChatId = null;
        let isRecording = false;
        let recognition = null;
        let currentMessage = '';
        
        // Initialize chat history from localStorage (shared with popup chatbot)
        let chatHistory = JSON.parse(localStorage.getItem('disasterAI_chatHistory') || '[]');
        
        // Initialize speech recognition
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            
            recognition.onstart = () => {
                isRecording = true;
                document.getElementById('micBtn').classList.add('recording');
                document.getElementById('micBtn').innerHTML = '<i class="fas fa-stop"></i>';
            };
            
            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript;
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                const messageInput = document.getElementById('messageInput');
                messageInput.value = currentMessage + finalTranscript + interimTranscript;
                
                if (finalTranscript) {
                    currentMessage += finalTranscript;
                }
            };
            
            recognition.onend = () => {
                isRecording = false;
                document.getElementById('micBtn').classList.remove('recording');
                document.getElementById('micBtn').innerHTML = '<i class="fas fa-microphone"></i>';
            };
            
            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                isRecording = false;
                document.getElementById('micBtn').classList.remove('recording');
                document.getElementById('micBtn').innerHTML = '<i class="fas fa-microphone"></i>';
            };
        }
        
        // DOM elements
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const micBtn = document.getElementById('micBtn');
        const fileInput = document.getElementById('fileInput');
        const messagesContainer = document.getElementById('messagesContainer');
        const emptyState = document.getElementById('emptyState');
        const chatTitle = document.getElementById('chatTitle');
        
        // Configuration for API handling
        let geminiApiKey = ''; // Will be set later
        const BACKEND_URL = 'http://localhost:5000'; // Backend server URL
        let backendAvailable = false;
        
        // Check backend availability on load
        async function checkBackendStatus() {
            try {
                const response = await fetch(`${BACKEND_URL}/api/status`);
                const data = await response.json();
                backendAvailable = data.backend_available;
                console.log('Backend status:', data);
                return data;
            } catch (error) {
                console.error('Backend not available:', error);
                backendAvailable = false;
                return null;
            }
        }
        
        const isGeminiAvailable = () => geminiApiKey && geminiApiKey.trim() !== '';
        
        document.addEventListener('DOMContentLoaded', function() {
            // Check backend availability
            checkBackendStatus();
            // Initialize user profile
            initializeUserProfile();
            
            // Event listeners
            messageInput.addEventListener('input', handleInputChange);
            messageInput.addEventListener('keypress', handleKeyPress);
            sendBtn.addEventListener('click', sendMessage);
            micBtn.addEventListener('click', toggleRecording);
            fileInput.addEventListener('change', handleFileUpload);
            
            // Initialize the app
            renderChatHistory();
            
            // Add click event to user profile
            document.querySelector('.user-profile').addEventListener('click', updateUserName);
            
            // Check if opened from consultation page
            if (document.referrer.includes('consultation.html') || window.opener) {
                setTimeout(async () => {
                    const backendStatus = await checkBackendStatus();
                    let welcomeMessage = "🚀 Welcome to Enhanced DisasterAI! You've accessed our improved chat interface with:\n\n✨ Better design and animations\n🆘 Advanced emergency protocols\n📁 Enhanced file upload support\n⌨️ Voice input capabilities\n🧠 Smarter AI responses\n\n";
                    
                    if (backendStatus && backendStatus.backend_available) {
                        welcomeMessage += "🔧 **Backend Status**: Connected ✅\n";
                        welcomeMessage += `📊 **Gemini API**: ${backendStatus.gemini_available ? 'Ready ✅' : 'Not configured ⚠️'}\n`;
                        welcomeMessage += `📁 **File Support**: ${backendStatus.supported_files.join(', ')}\n`;
                        welcomeMessage += `📏 **Max File Size**: ${backendStatus.max_file_size_mb}MB\n\n`;
                        
                        if (!backendStatus.gemini_available) {
                            welcomeMessage += "💡 **Tip**: Set your Gemini API key using setGeminiApiKey('your-key') in console for enhanced AI features.\n\n";
                        }
                    } else {
                        welcomeMessage += "⚠️ **Backend Status**: Offline (using local responses)\n\n";
                        welcomeMessage += "💡 **Tip**: Start the Python backend server for enhanced AI features with specialized prompts.\n\n";
                    }
                    
                    welcomeMessage += "How can I assist you today?";
                    
                    addMessage(welcomeMessage, 'ai');
                    emptyState.style.display = 'none';
                }, 500);
            }
        });
        
        // Auto-resize textarea
        function handleInputChange() {
            const textarea = messageInput;
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            
            // Enable/disable send button
            sendBtn.disabled = !textarea.value.trim();
        }
        
        function handleKeyPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }
        
        function toggleRecording() {
            if (!recognition) {
                alert('Speech recognition is not supported in your browser.');
                return;
            }
            
            if (isRecording) {
                recognition.stop();
            } else {
                currentMessage = messageInput.value;
                recognition.start();
            }
        }
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Validate file size (max 10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('⚠️ File too large\n\nPlease select a file smaller than 10MB.');
                event.target.value = '';
                return;
            }
            
            // Validate file type
            const allowedTypes = ['image/', 'video/', 'application/pdf'];
            const isValidType = allowedTypes.some(type => file.type.startsWith(type));
            
            if (!isValidType) {
                alert('⚠️ Unsupported file type\n\nPlease select an image, video, or PDF file.');
                event.target.value = '';
                return;
            }
            
            // Hide empty state
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            // Create new chat if needed
            if (!currentChatId) {
                startNewChat();
            }
            
            // Add file message
            addFileMessage(file);
            
            // Clear file input
            event.target.value = '';
            
            // Process file
            processFile(file);
        }
        
        function addFileMessage(file) {
            const messagesDiv = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.id = `file-message-${Date.now()}`;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            // Determine file icon and color
            let iconClass = 'fas fa-file';
            let iconColor = '#6c757d';
            
            if (file.type.startsWith('image/')) {
                iconClass = 'fas fa-image';
                iconColor = '#17a2b8';
            } else if (file.type.startsWith('video/')) {
                iconClass = 'fas fa-video';
                iconColor = '#e83e8c';
            } else if (file.type === 'application/pdf') {
                iconClass = 'fas fa-file-pdf';
                iconColor = '#dc3545';
            }
            
            const fileSize = formatFileSize(file.size);
            
            let fileContent = `
                <div class="file-message upload-progress">
                    <div class="file-icon" style="background: ${iconColor}">
                        <i class="${iconClass}"></i>
                    </div>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${fileSize}</div>
                    </div>
                </div>
            `;
            
            // Add image preview for images
            if (file.type.startsWith('image/')) {
                const imageUrl = URL.createObjectURL(file);
                fileContent += `<img src="${imageUrl}" class="file-preview" alt="Preview">`;
            }
            
            messageDiv.innerHTML = `
                <div class="message-avatar user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="message-content">
                    ${fileContent}
                    <div class="message-time">${timeString}</div>
                </div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            return messageDiv;
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function processFile(file) {
            if (backendAvailable) {
                // Process with backend API (which will use specialized prompts + Gemini)
                processWithBackend(file);
            } else if (isGeminiAvailable()) {
                // Fallback to direct Gemini API
                processWithGemini(file);
            } else {
                // Fallback to local processing
                processLocally(file);
            }
        }
        
        async function processWithBackend(file, userMessage = '') {
            showTypingIndicator();
            
            try {
                const formData = new FormData();
                formData.append('message', userMessage || `[File: ${file.name}] Please analyze this file and provide disaster management guidance.`);
                formData.append('files', file);
                
                const response = await fetch(`${BACKEND_URL}/api/chat`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    hideTypingIndicator();
                    addMessage(data.response, 'ai');
                    updateChatHistory(`[File: ${file.name}]`, data.response);
                } else {
                    throw new Error(data.error || 'Backend processing failed');
                }
                
            } catch (error) {
                console.error('Backend processing error:', error);
                hideTypingIndicator();
                
                // Fallback to direct Gemini API if backend fails
                if (isGeminiAvailable()) {
                    addMessage('⚠️ Backend temporarily unavailable. Falling back to direct Gemini API...', 'ai');
                    setTimeout(() => processWithGemini(file), 1000);
                } else {
                    addMessage('⚠️ Sorry, I encountered an error processing your file. Please ensure the backend server is running or provide a Gemini API key.', 'ai');
                }
            }
        }
        
        async function processWithGemini(file) {
            showTypingIndicator();
            
            try {
                // Convert file to base64
                const base64Data = await fileToBase64(file);
                
                // Prepare the request
                const requestBody = {
                    contents: [{
                        parts: [
                            {
                                text: getGeminiPrompt(file.type)
                            },
                            {
                                inline_data: {
                                    mime_type: file.type,
                                    data: base64Data.split(',')[1] // Remove data:type;base64, prefix
                                }
                            }
                        ]
                    }]
                };
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const aiResponse = data.candidates[0]?.content?.parts[0]?.text || 'Sorry, I could not analyze this file.';
                
                hideTypingIndicator();
                addMessage(aiResponse, 'ai');
                updateChatHistory(`[File: ${file.name}]`, aiResponse);
                
            } catch (error) {
                console.error('Gemini API error:', error);
                hideTypingIndicator();
                addMessage('⚠️ Sorry, I encountered an error processing your file. Please try again or contact support if the issue persists.', 'ai');
            }
        }
        
        function processLocally(file) {
            showTypingIndicator();
            
            setTimeout(() => {
                hideTypingIndicator();
                
                let response = '';
                if (file.type.startsWith('image/')) {
                    response = `📸 **Image Received: ${file.name}**\n\nI can see you've shared an image. For detailed image analysis, please provide the Gemini API key. In the meantime, here are some general tips:\n\n• If this shows disaster damage, stay safe and contact authorities\n• Document important information for insurance claims\n• Share with emergency services if immediate help is needed\n\n💡 **Note:** With Gemini API, I can provide detailed analysis of what I see in your image.`;
                } else if (file.type.startsWith('video/')) {
                    response = `🎥 **Video Received: ${file.name}**\n\nI've received your video file. For detailed video analysis, please provide the Gemini API key. General guidance:\n\n• If this shows an emergency situation, contact 911 immediately\n• Videos can be valuable evidence for authorities\n• Ensure your safety before recording in dangerous situations\n\n💡 **Note:** With Gemini API, I can analyze video content and provide specific guidance.`;
                } else if (file.type === 'application/pdf') {
                    response = `📄 **PDF Document Received: ${file.name}**\n\nI've received your PDF document. For detailed document analysis, please provide the Gemini API key. In the meantime:\n\n• If this contains emergency information, please share key details in text\n• I can help interpret standard emergency procedures\n• For immediate guidance, describe your situation in text\n\n💡 **Note:** With Gemini API, I can read and analyze your PDF content directly.`;
                }
                
                addMessage(response, 'ai');
                updateChatHistory(`[File: ${file.name}]`, response);
            }, 1000 + Math.random() * 500);
        }
        
        function getGeminiPrompt(fileType) {
            if (fileType.startsWith('image/')) {
                return "You are DisasterAI, an emergency support assistant. Analyze this image and provide helpful guidance. If you see any signs of disaster, damage, flooding, fire, or emergency situations, provide specific safety advice. If it's a preparedness-related image, offer relevant tips. Be supportive, practical, and focus on safety. Keep responses concise but helpful.";
            } else if (fileType.startsWith('video/')) {
                return "You are DisasterAI, an emergency support assistant. Analyze this video and provide helpful guidance. Look for any signs of disaster, emergency situations, safety procedures, or preparedness activities. Provide specific, actionable advice based on what you observe. Be supportive and focus on safety. Keep responses concise but comprehensive.";
            } else if (fileType === 'application/pdf') {
                return "You are DisasterAI, an emergency support assistant. Analyze this PDF document and provide helpful guidance. If it contains emergency procedures, disaster plans, safety information, or preparedness materials, summarize key points and offer additional relevant advice. Be supportive and practical. Keep responses concise but informative.";
            }
            return "You are DisasterAI, an emergency support assistant. Analyze this file and provide helpful guidance related to disaster preparedness, emergency response, or safety. Be supportive and practical.";
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }
        
        // Function to set Gemini API key (to be called from outside)
        function setGeminiApiKey(apiKey) {
            geminiApiKey = apiKey;
            console.log('Gemini API key configured');
            
            // Also configure backend if available
            if (backendAvailable) {
                configureBackendApiKey(apiKey);
            }
        }
        
        async function configureBackendApiKey(apiKey) {
            try {
                const response = await fetch(`${BACKEND_URL}/api/config`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        api_key: apiKey
                    })
                });
                
                const data = await response.json();
                console.log('Backend API key configuration:', data);
                
            } catch (error) {
                console.error('Failed to configure backend API key:', error);
            }
        }
        
        // Make it globally accessible
        window.setGeminiApiKey = setGeminiApiKey;
        
        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;
            
            // Hide empty state
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            // Create new chat if needed
            if (!currentChatId) {
                startNewChat();
            }
            
            // Add user message
            addMessage(message, 'user');
            
            // Clear input
            messageInput.value = '';
            currentMessage = '';
            handleInputChange();
            
            // Show typing indicator
            showTypingIndicator();
            
            // Process message with backend or fallback
            if (backendAvailable) {
                processMessageWithBackend(message);
            } else {
                // Fallback to local SLM responses
                setTimeout(() => {
                    hideTypingIndicator();
                    const response = generateAIResponse(message);
                    addMessage(response, 'ai');
                    updateChatHistory(message, response);
                }, 1500 + Math.random() * 1000);
            }
        }
        
        async function processMessageWithBackend(message) {
            try {
                const response = await fetch(`${BACKEND_URL}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                hideTypingIndicator();
                
                if (data.success) {
                    addMessage(data.response, 'ai');
                    updateChatHistory(message, data.response);
                } else {
                    throw new Error(data.error || 'Backend processing failed');
                }
                
            } catch (error) {
                console.error('Backend message processing error:', error);
                hideTypingIndicator();
                
                // Fallback to local processing
                const response = generateAIResponse(message);
                addMessage('⚠️ Backend temporarily unavailable. Using local responses.\n\n' + response, 'ai');
                updateChatHistory(message, response);
            }
        }
        
        function sendSuggestion(message) {
            messageInput.value = message;
            sendMessage();
        }
        
        function addMessage(content, type) {
            const messagesDiv = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div class="message-avatar ${type}-avatar">
                    <i class="fas fa-${type === 'user' ? 'user' : 'robot'}"></i>
                </div>
                <div class="message-content">
                    <div class="message-text">${content}</div>
                    <div class="message-time">${timeString}</div>
                </div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function showTypingIndicator() {
            const messagesDiv = document.getElementById('messagesContainer');
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typingIndicator';
            
            typingDiv.innerHTML = `
                <div class="message-avatar ai-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            
            messagesDiv.appendChild(typingDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }
        
        function generateAIResponse(userMessage) {
            // For text-only messages, use local SLM responses
            const responses = {
                flood: [
                    "🌊 For flood safety: Move to higher ground immediately, avoid walking or driving through flood water, and listen to emergency broadcasts. Stay safe!",
                    "During a flood, remember: Turn around, don't drown! Just 6 inches of moving water can knock you down, and 12 inches can carry away a vehicle.",
                    "🚨 Flood emergency steps:\n1. Get to higher ground\n2. Avoid flooded roads\n3. Stay informed via radio\n4. Have emergency supplies ready\n\nDo you need specific evacuation guidance?"
                ],
                anxiety: [
                    "😌 I understand you're feeling anxious. Try this breathing exercise: Breathe in for 4 counts, hold for 4, exhale for 6. Repeat 5 times. You're not alone in this.",
                    "🤗 Anxiety during disasters is completely normal. Focus on what you can control: your safety, breathing, and staying informed. Would you like some grounding techniques?",
                    "💙 It's okay to feel overwhelmed. Here are some immediate coping strategies:\n• Deep breathing\n• 5-4-3-2-1 grounding technique\n• Stay hydrated\n• Connect with loved ones\n\nHow are you feeling right now?"
                ],
                emergency: [
                    "🆘 For immediate emergencies, call 911 right away. If you're in immediate danger:\n1. Get to safety first\n2. Call emergency services\n3. Follow official evacuation orders\n\nWhat's your current situation?",
                    "🚨 Emergency priorities:\n1. Ensure personal safety\n2. Call 911 if needed\n3. Follow official guidance\n4. Stay informed\n\nAre you currently in a safe location?",
                    "⚠️ If this is a life-threatening emergency, please call 911 immediately. For non-emergency support, I'm here to help with guidance and resources."
                ],
                preparedness: [
                    "🎒 Emergency preparedness essentials:\n• 72-hour emergency kit\n• First aid supplies\n• Important documents\n• Emergency contacts list\n• Flashlight & batteries\n\nWould you like details on any of these?",
                    "📋 Great question! Start with these basics:\n1. Emergency kit with food/water\n2. Communication plan\n3. Important documents copies\n4. First aid knowledge\n\nWhat type of disasters are most common in your area?",
                    "🏠 Home preparedness checklist:\n✓ Emergency supplies\n✓ Evacuation plan\n✓ Important documents\n✓ Emergency contacts\n✓ First aid kit\n\nLet's work on your family emergency plan!"
                ],
                firstaid: [
                    "🏥 Basic first aid priorities:\n1. Check for responsiveness\n2. Call for help if needed\n3. Control bleeding\n4. Treat for shock\n\nWhat specific first aid situation do you need help with?",
                    "🩹 First aid basics everyone should know:\n• CPR and AED use\n• Wound care\n• Choking response\n• Shock treatment\n\nWould you like step-by-step instructions for any of these?",
                    "⚕️ Remember the first aid ABCs:\n• Airway - keep it clear\n• Breathing - check and assist\n• Circulation - control bleeding\n\nDo you need guidance for a specific injury or emergency?"
                ],
            };
            
            const lowerMessage = userMessage.toLowerCase();
            
            if (lowerMessage.includes('flood') || lowerMessage.includes('water')) {
                return responses.flood[Math.floor(Math.random() * responses.flood.length)];
            } else if (lowerMessage.includes('anxious') || lowerMessage.includes('stress') || lowerMessage.includes('worried') || lowerMessage.includes('scared')) {
                return responses.anxiety[Math.floor(Math.random() * responses.anxiety.length)];
            } else if (lowerMessage.includes('emergency') || lowerMessage.includes('help') || lowerMessage.includes('immediate')) {
                return responses.emergency[Math.floor(Math.random() * responses.emergency.length)];
            } else if (lowerMessage.includes('preparedness') || lowerMessage.includes('prepare') || lowerMessage.includes('kit') || lowerMessage.includes('plan')) {
                return responses.preparedness[Math.floor(Math.random() * responses.preparedness.length)];
            } else if (lowerMessage.includes('first aid') || lowerMessage.includes('medical') || lowerMessage.includes('injury') || lowerMessage.includes('wound')) {
                return responses.firstaid[Math.floor(Math.random() * responses.firstaid.length)];
            }
            
            // Default response
            return "I'm here to help you with disaster preparedness, emergency guidance, and psychological support. Could you tell me more about what specific assistance you need? Whether it's safety information, stress management, or emergency planning, I'm ready to help! 🤖💙\n\n💡 **Tip:** You can also upload images, videos, or PDFs for detailed analysis (requires Gemini API key).";
        }
        
        function startNewChat() {
            currentChatId = Date.now().toString();
            chatTitle.textContent = 'New Chat';
            
            // Clear message input
            const messageInput = document.getElementById('messageInput');
            messageInput.value = '';
            messageInput.style.height = 'auto';
            
            // Clear messages and show empty state
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.innerHTML = `
                <div class="empty-state" id="emptyState">
                    <div class="empty-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="empty-title">How can I help you today?</div>
                    <div class="empty-subtitle">Ask me about disaster preparedness, emergency situations, or if you need psychological support. Upload images, videos, or PDFs for specialized analysis with enhanced AI prompts.</div>
                    
                    <div class="suggestion-chips">
                        <div class="chip" onclick="sendSuggestion('I am feeling anxious about disaster')">😰 Feeling Anxious</div>
                        <div class="chip" onclick="sendSuggestion('Emergency preparedness tips')">🎒 Preparedness</div>
                        <div class="chip" onclick="sendSuggestion('First aid guidance')">🏥 First Aid</div>
                    </div>
                </div>
            `;
            
            // Update chat history UI to show active state
            renderChatHistory();
            
            // Enable send button state
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
        }
        
        function updateChatHistory(userMessage, aiResponse) {
            if (!currentChatId) return;
            
            // Find existing chat or create new one
            let chat = chatHistory.find(c => c.id === currentChatId);
            if (!chat) {
                chat = {
                    id: currentChatId,
                    title: userMessage.substring(0, 50) + (userMessage.length > 50 ? '...' : ''),
                    messages: [],
                    timestamp: new Date().toISOString()
                };
                chatHistory.unshift(chat);
            }
            
            // Add messages
            chat.messages.push(
                { type: 'user', content: userMessage, timestamp: new Date().toISOString() },
                { type: 'ai', content: aiResponse, timestamp: new Date().toISOString() }
            );
            
            // Update title if this is the first exchange
            if (chat.messages.length === 2) {
                chat.title = userMessage.substring(0, 50) + (userMessage.length > 50 ? '...' : '');
                chatTitle.textContent = chat.title;
            }
            
            // Save to localStorage
            localStorage.setItem('disasterAI_chatHistory', JSON.stringify(chatHistory));
            
            // Re-render history
            renderChatHistory();
        }
        
        function renderChatHistory() {
            const historyContainer = document.getElementById('chatHistory');
            
            if (chatHistory.length === 0) {
                historyContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 13px;">
                        No chat history yet. Start a conversation!
                    </div>
                `;
                return;
            }
            
            historyContainer.innerHTML = chatHistory.map(chat => {
                // Handle both old and new chat format
                const date = new Date(chat.lastUpdate || chat.timestamp || chat.startTime);
                const timeString = date.toLocaleDateString() === new Date().toLocaleDateString() 
                    ? date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                    : date.toLocaleDateString();
                
                // Get preview from first user message
                let preview = '';
                if (chat.messages && chat.messages.length > 0) {
                    const firstUserMsg = chat.messages.find(msg => msg.type === 'user' || msg.role === 'user');
                    if (firstUserMsg) {
                        preview = firstUserMsg.content.substring(0, 60) + (firstUserMsg.content.length > 60 ? '...' : '');
                    } else {
                        preview = chat.messages[0].content.substring(0, 60) + (chat.messages[0].content.length > 60 ? '...' : '');
                    }
                } else {
                    preview = 'New conversation';
                }
                
                // Add source indicator for popup chats
                const sourceIndicator = chat.source === 'popup' ? ' <span style="color: var(--primary); font-size: 11px;">📱 Popup</span>' : '';
                
                return `
                    <div class="history-item ${chat.id === currentChatId ? 'active' : ''}" onclick="loadChat('${chat.id}')">
                        <div class="history-content">
                            <div class="history-title" id="title-${chat.id}">${chat.title}${sourceIndicator}</div>
                            <div class="history-preview">${preview}</div>
                            <div class="history-time">${timeString}</div>
                        </div>
                        <button class="edit-chat-btn" onclick="editChatName('${chat.id}', event)" title="Rename chat">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-chat-btn" onclick="deleteChat('${chat.id}', event)" title="Delete chat">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }
        
        function loadChat(chatId) {
            const chat = chatHistory.find(c => c.id === chatId);
            if (!chat) return;
            
            currentChatId = chatId;
            chatTitle.textContent = chat.title;
            
            // Clear messages
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.innerHTML = '';
            
            // Load messages - handle both old and new format
            if (chat.messages && chat.messages.length > 0) {
                chat.messages.forEach(message => {
                    // Handle popup chatbot format (type) vs full chatbot format (role)
                    const messageType = message.type || message.role;
                    // Convert 'bot' to 'ai' for consistency
                    const displayType = messageType === 'bot' ? 'ai' : messageType;
                    addMessage(message.content, displayType);
                });
            }
            
            // Hide empty state
            const emptyState = document.getElementById('emptyState');
            if (emptyState) {
                emptyState.style.display = 'none';
            }
            
            // Update active state in history
            renderChatHistory();
        }
        
        // Search functionality
        function toggleSearch() {
            const searchContainer = document.getElementById('searchContainer');
            const searchInput = document.getElementById('searchInput');
            
            if (searchContainer.style.display === 'none') {
                searchContainer.style.display = 'block';
                searchInput.focus();
            } else {
                searchContainer.style.display = 'none';
                searchInput.value = '';
                renderChatHistory(); // Reset to show all chats
            }
        }
        
        function searchChats() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const historyContainer = document.getElementById('chatHistory');
            
            if (!searchTerm) {
                renderChatHistory();
                return;
            }
            
            const filteredChats = chatHistory.filter(chat => {
                const title = chat.title.toLowerCase();
                const content = chat.messages.map(m => m.content.toLowerCase()).join(' ');
                return title.includes(searchTerm) || content.includes(searchTerm);
            });
            
            if (filteredChats.length === 0) {
                historyContainer.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 13px;">
                        No chats found for "${searchTerm}"
                    </div>
                `;
                return;
            }
            
            historyContainer.innerHTML = filteredChats.map(chat => {
                const date = new Date(chat.timestamp);
                const timeString = date.toLocaleDateString() === new Date().toLocaleDateString() 
                    ? date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                    : date.toLocaleDateString();
                
                const preview = chat.messages[0]?.content.substring(0, 60) + (chat.messages[0]?.content.length > 60 ? '...' : '') || 'New conversation';
                
                return `
                    <div class="history-item ${chat.id === currentChatId ? 'active' : ''}" onclick="loadChat('${chat.id}')">
                        <div class="history-content">
                            <div class="history-title" id="title-${chat.id}">${chat.title}</div>
                            <div class="history-preview">${preview}</div>
                            <div class="history-time">${timeString}</div>
                        </div>
                        <button class="edit-chat-btn" onclick="editChatName('${chat.id}', event)" title="Rename chat">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-chat-btn" onclick="deleteChat('${chat.id}', event)" title="Delete chat">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }
        
        // Edit chat name functionality
        function editChatName(chatId, event) {
            // Prevent triggering the loadChat function
            event.stopPropagation();
            
            // Find the chat in history
            const chat = chatHistory.find(c => c.id === chatId);
            if (!chat) return;
            
            // Prompt for new name
            const newName = prompt('Enter new chat name:', chat.title);
            if (newName && newName.trim() && newName.trim() !== chat.title) {
                // Update the chat title
                chat.title = newName.trim();
                
                // Update localStorage
                localStorage.setItem('disasterAI_chatHistory', JSON.stringify(chatHistory));
                
                // Update the current chat title if this is the active chat
                if (currentChatId === chatId) {
                    const chatTitle = document.getElementById('chatTitle');
                    chatTitle.textContent = chat.title;
                }
                
                // Refresh the history display
                renderChatHistory();
            }
        }
        
        // Delete chat functionality
        function deleteChat(chatId, event) {
            // Prevent triggering the loadChat function
            event.stopPropagation();
            
            // Confirm deletion
            if (confirm('Are you sure you want to delete this chat?')) {
                // Remove from chatHistory array
                chatHistory = chatHistory.filter(chat => chat.id !== chatId);
                
                // Update localStorage
                localStorage.setItem('disasterAI_chatHistory', JSON.stringify(chatHistory));
                
                // If the deleted chat was the current one, start a new chat
                if (currentChatId === chatId) {
                    startNewChat();
                } else {
                    // Just refresh the history display
                    renderChatHistory();
                }
            }
        }
        
        // User profile functionality
        function initializeUserProfile() {
            const userName = localStorage.getItem('userName') || 'User';
            const userAvatar = document.getElementById('userAvatar');
            const userNameElement = document.getElementById('userName');
            
            userNameElement.textContent = userName;
            userAvatar.textContent = userName.charAt(0).toUpperCase();
        }
        
        function updateUserName() {
            const newName = prompt('Enter your name:', localStorage.getItem('userName') || 'User');
            if (newName && newName.trim()) {
                localStorage.setItem('userName', newName.trim());
                initializeUserProfile();
            }
        }
        
        // Handle window resize for mobile
        window.addEventListener('resize', function() {
            // Adjust layout for mobile devices
            if (window.innerWidth <= 640) {
                // Mobile specific adjustments can be added here
            }
        });
    </script>
</body>
</html>